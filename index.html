<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Direct Monte-Carlo Simulator</title>
    <!-- Исправлены CDN ссылки -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@latest"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 150px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-family: monospace; }
        button { background: #ffcc00; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        button:hover { background: #f0c000; }
        #results { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 6px; border-left: 5px solid #ffcc00; }
        canvas { margin-top: 20px; max-width: 100%; }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Симулятор аукциона Яндекс.Директ</h2>
    <p>Скопируйте `<tr>` или всю таблицу из "Прогноза бюджета" и вставьте ниже:</p>
    <div class="error" id="errorMessage"></div>
    <textarea id="htmlInput" placeholder="Вставьте HTML код строки фразы здесь..."></textarea>
    <button id="simulateBtn">Запустить симуляцию</button>

    <div id="results" style="display:none;">
        <div class="stat-card">
            <h3>Прогноз кликов</h3>
            <p id="clickMean">Среднее: --</p>
            <small id="clickRange">Диапазон (95%): --</small>
        </div>
        <div class="stat-card">
            <h3>Прогноз бюджета</h3>
            <p id="costMean">Среднее: --</p>
            <small id="costSafe">Безопасный остаток: --</small>
        </div>
    </div>
    
    <canvas id="distChart"></canvas>
</div>

<script>
    let chart = null;
    
    // Ждем загрузки DOM
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('simulateBtn').addEventListener('click', processData);
        
        // Также запускаем по Ctrl+Enter в textarea
        document.getElementById('htmlInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                processData();
            }
        });
    });

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function hideError() {
        document.getElementById('errorMessage').style.display = 'none';
    }

    async function processData() {
        hideError();
        const html = document.getElementById('htmlInput').value.trim();
        
        if (!html) {
            showError("Пожалуйста, вставьте HTML код");
            return;
        }

        const parser = new DOMParser();
        // Оборачиваем в table для корректного парсинга
        const wrappedHtml = html.startsWith('<tr') ? `<table>${html}</table>` : html;
        const doc = parser.parseFromString(wrappedHtml, 'text/html');

        try {
            // 1. Парсинг данных - используем более надежные селекторы
            const keywordElement = doc.querySelector('.js-phrase-cell');
            const requestsElement = doc.querySelector('.js-requests-cell');
            
            if (!keywordElement || !requestsElement) {
                throw new Error("Не удалось найти данные фразы. Убедитесь, что скопировали строку из Яндекс.Директ");
            }
            
            const keyword = keywordElement.innerText.trim();
            const totalRequests = parseInt(requestsElement.innerText.replace(/\s/g, '')) || 0;
            
            // Собираем данные по позициям
            const ctrElements = doc.querySelectorAll('.js-ctr-values-by-positions .js-value');
            const priceElements = doc.querySelectorAll('.js-amnesty_price-values-by-positions .js-value');
            
            if (ctrElements.length === 0 || priceElements.length === 0) {
                throw new Error("Не удалось найти данные по CTR или ценам");
            }
            
            const ctrs = Array.from(ctrElements).map(el => parseFloat(el.innerText) || 0);
            const prices = Array.from(priceElements).map(el => parseFloat(el.innerText) || 0);
            
            // Находим активную позицию
            const activeItems = doc.querySelectorAll('.js-positions-list li');
            let activeIdx = 0;
            Array.from(activeItems).forEach((li, idx) => {
                if (li.classList.contains('active')) {
                    activeIdx = idx;
                }
            });
            
            // Объемы показов для позиций (примерные значения)
            const volumes = [100, 85, 62, 9, 5];
            
            const phraseData = {
                keyword,
                totalRequests,
                active: { 
                    ctr: ctrs[activeIdx] || ctrs[0], 
                    price: prices[activeIdx] || prices[0], 
                    vol: volumes[activeIdx] || volumes[0] 
                }
            };

            runSimulation(phraseData);
        } catch (e) {
            showError(`Ошибка парсинга: ${e.message}. Пожалуйста, убедитесь, что скопировали строку таблицы целиком.`);
            console.error(e);
        }
    }

    async function runSimulation(data) {
        const iterations = 5000;
        const n = data.totalRequests;
        const p = (data.active.ctr || 0) / 100;
        const avgCpc = data.active.price || 0;

        if (n === 0 || p === 0) {
            showError("Нет данных для симуляции. Проверьте вставленные данные.");
            return;
        }

        const { clicks, costs } = tf.tidy(() => {
            const mu = n * p;
            const sigma = Math.sqrt(n * p * (1 - p)) * 1.5;
            
            const clicksDist = tf.randomNormal([iterations], mu, sigma);
            const cpcVolatility = tf.randomUniform([iterations], avgCpc * 0.8, avgCpc * 1.2);
            const costsDist = clicksDist.mul(cpcVolatility);
            
            return { 
                clicks: clicksDist.dataSync(), 
                costs: costsDist.dataSync() 
            };
        });

        // Отрисовка результатов
        document.getElementById('results').style.display = 'grid';
        const sortedClicks = Array.from(clicks).sort((a, b) => a - b);
        const sortedCosts = Array.from(costs).sort((a, b) => a - b);

        document.getElementById('clickMean').innerText = `Среднее: ${Math.round(sortedClicks[Math.floor(sortedClicks.length/2)])} кликов`;
        document.getElementById('clickRange').innerText = `Диапазон (95%): ${Math.round(sortedClicks[Math.floor(sortedClicks.length*0.025)])} - ${Math.round(sortedClicks[Math.floor(sortedClicks.length*0.975)])}`;
        
        document.getElementById('costMean').innerText = `Среднее: ${Math.round(sortedCosts[Math.floor(sortedCosts.length/2)]).toLocaleString('ru-RU')} руб.`;
        document.getElementById('costSafe').innerText = `Нужно на балансе (95% уверенности): ${Math.round(sortedCosts[Math.floor(sortedCosts.length*0.95)]).toLocaleString('ru-RU')} руб.`;

        updateChart(sortedClicks);
    }

    function updateChart(data) {
        const ctx = document.getElementById('distChart').getContext('2d');
        if (chart) {
            chart.destroy();
        }

        // Строим гистограмму распределения
        const bins = 40;
        const min = Math.min(...data);
        const max = Math.max(...data);
        const step = (max - min) / bins;
        
        // Создаем биннинг
        const histogram = new Array(bins).fill(0);
        const labels = new Array(bins);
        
        for (let i = 0; i < bins; i++) {
            labels[i] = Math.round(min + i * step);
        }
        
        data.forEach(v => {
            const binIdx = Math.min(Math.floor((v - min) / step), bins - 1);
            histogram[binIdx]++;
        });

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Распределение кликов',
                    data: histogram,
                    backgroundColor: '#ffcc00',
                    borderColor: '#e6b800',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Кликов: ${context.label}, Частота: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Частота'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Количество кликов'
                        }
                    }
                }
            }
        });
    }
</script>
</body>
</html>